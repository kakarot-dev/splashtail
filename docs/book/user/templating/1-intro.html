<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Introduction - AntiRaid Documentation</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../index.html">Introduction</a></li><li class="chapter-item expanded affix "><li class="part-title">User Guide</li><li class="chapter-item expanded "><a href="../../user/permissions/index.html"><strong aria-hidden="true">1.</strong> Permissions</a></li><li class="chapter-item expanded "><a href="../../user/templating/index.html"><strong aria-hidden="true">2.</strong> Templating</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../user/templating/1-intro.html" class="active"><strong aria-hidden="true">2.1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../../user/templating/2-plugins.html"><strong aria-hidden="true">2.2.</strong> Plugins</a></li><li class="chapter-item expanded "><a href="../../user/templating/3-example.html"><strong aria-hidden="true">2.3.</strong> A Simple Example</a></li><li class="chapter-item expanded "><a href="../../user/templating/4-luau-ecosystem.html"><strong aria-hidden="true">2.4.</strong> Ecosystem</a></li></ol></li><li class="chapter-item expanded "><a href="../../user/captcha/index.html"><strong aria-hidden="true">3.</strong> Captcha</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../user/captcha/1-intro.html"><strong aria-hidden="true">3.1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../../user/captcha/2-examples.html"><strong aria-hidden="true">3.2.</strong> Examples</a></li></ol></li><li class="chapter-item expanded "><a href="../../user/lockdown/index.html"><strong aria-hidden="true">4.</strong> Lockdown</a></li><li class="chapter-item expanded "><a href="../../user/modifiers/1-modifiers.html"><strong aria-hidden="true">5.</strong> Modifiers</a></li><li class="chapter-item expanded "><a href="../../user/backups/index.html"><strong aria-hidden="true">6.</strong> Backups</a></li><li class="chapter-item expanded affix "><li class="part-title">Developer Guide</li><li class="chapter-item expanded "><a href="../../dev/go_jobs/index.html"><strong aria-hidden="true">7.</strong> Go Jobserver</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../dev/go_jobs/backups.html"><strong aria-hidden="true">7.1.</strong> Backups</a></li></ol></li><li class="chapter-item expanded "><a href="../../dev/rust_bot_modules_lockdown/index.html"><strong aria-hidden="true">8.</strong> Lockdown Module</a></li><li class="chapter-item expanded "><a href="../../dev/rust_silverpelt/index.html"><strong aria-hidden="true">9.</strong> Silverpelt</a></li><li class="chapter-item expanded "><a href="../../dev/rust_templating/index.html"><strong aria-hidden="true">10.</strong> Templating</a></li><li class="chapter-item expanded "><a href="../../dev/rust_text/index.html"><strong aria-hidden="true">11.</strong> Text</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">AntiRaid Documentation</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="lua-templating"><a class="header" href="#lua-templating">Lua Templating</a></h1>
<p>At AntiRaid, we prioritize flexibility and customization for our users. To this end, our bot supports advanced templating to allow for extensive personalization of embeds and messages. While many bots utilize proprietary languages or templating engines, we have chosen to leverage Luaâ€”a renowned scripting language widely used in game development and other applications. This decision ensures that our users benefit from a powerful, well-documented, and versatile language, enhancing the capability and ease of customizing their AntiRaid experience.</p>
<p>Specifically, Anti Raid uses a variant of Lua called Luau. If you've ever used Roblox before, this is the same variant of Lua used there too (which is why Luau is also known as Roblox Lua in many places). You can check out the <a href="https://luau-lang.org/">Luau docs</a> for more information on the language itself. Unlike PUC Lua (the reference implementation), Luau is both faster and offers robust sandboxing capabilities allowing AntiRaid to run scripts in as safe an environment as possible.</p>
<h2 id="getting-started"><a class="header" href="#getting-started">Getting Started</a></h2>
<p>Note that the remainder of these docs will cover AntiRaids Lua SDKs. To learn more about Lua itself, please checkout Lua's official tutorial for Lua 5.0 <a href="https://www.lua.org/pil/1.html">here</a>. Other resources for Lua exist (Lua is very popular after all), including <a href="https://devforum.roblox.com/t/lua-scripting-starter-guide/394618#print-5">Roblox's tutorial</a> (ignore the Studio bits), <a href="https://www.tutorialspoint.com/lua/lua_quick_guide.htm">TutorialPoint</a> and <a href="https://www.codecademy.com/learn/learn-lua">Codecademy</a>.</p>
<h2 id="limitations"><a class="header" href="#limitations">Limitations</a></h2>
<p>AntiRaid applies the following 3 global limits to all Lua templates. Note that we may provide increased limits as a Premium feature in the future:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub const MAX_TEMPLATE_MEMORY_USAGE: usize = 1024 * 1024 * 3; // 3MB maximum memory
pub const MAX_TEMPLATE_LIFETIME: std::time::Duration = std::time::Duration::from_secs(60 * 15); // 15 minutes maximum lifetime
pub const MAX_TEMPLATES_EXECUTION_TIME: std::time::Duration = std::time::Duration::from_secs(30); // 30 seconds maximum execution time
<span class="boring">}</span></code></pre></pre>
<p>The above limits are in place to prevent abuse and ensure that the bot remains responsive. If you require increased limits, please contact support (once again, this may change in the future).</p>
<h2 id="some-key-notes"><a class="header" href="#some-key-notes">Some key notes</a></h2>
<ul>
<li>Each guild is assigned a dedicated Lua VM. This VM is used to execute Lua code that is used in the templates.</li>
<li>The total memory usage that a guild can use is limited to <code>MAX_TEMPLATE_MEMORY_USAGE</code> (currently 3MB). This is to prevent a single guild from using too much memory.</li>
<li>Execution of all scripts is timed out when the last executed script takes longer than <code>MAX_TEMPLATES_EXECUTION_TIME</code> (currently 30 seconds).</li>
<li>A lua VM will exist for a total of <code>MAX_TEMPLATE_LIFETIME</code> (currently 10 minutes) after the last access before being destroyed. This is to reduce memory+CPU usage.</li>
<li>The <code>__stack</code> table can be used to share data across templates safely <em>while the VM is running</em>. without affecting other templates. This is useful for sharing data between templates such as Audit Logs. <strong>Note that AntiRaid uses luau sandboxing meaning that <code>_G</code> is readonly.</strong></li>
<li>The standard <code>require</code> statement can be used to import AntiRaid modules. <strong>Note that the modules are read-only</strong> and cannot be monkey-patched etc.</li>
<li><strong>Because Lua is a single-threaded language, only one template can be executed at a time</strong></li>
</ul>
<p>There are 2 valid syntax for a Luau template:</p>
<ol>
<li>Lua script syntax</li>
</ol>
<pre><code class="language-lua">local args, token = ...
-- Do something
return output
</code></pre>
<ol start="2">
<li>Function expression syntax (not recommended for new code)</li>
</ol>
<pre><code class="language-lua">function(args, token)
    -- Do something
    return output
end
</code></pre>
<p>Note that option 1 is recommended as it is both more idiomatic and is also valid syntax for LSP's and Luau parsers. Note that option 2 is actually converted to option 1 internally through the below wrapper:</p>
<pre><code>local args, token = ...
{function body here}
</code></pre>
<h2 id="interop"><a class="header" href="#interop">Interop</a></h2>
<p>Many features of Lua don't work so well when calling functions within the AntiRaid SDK. For example, both arrays and maps are expressed as tables in Lua. However, AntiRaid, being written in Rust, doesn't know this and hance needs some help to convert certain types for FFI. This is where the <code>@antiraid/interop</code> module comes in.</p>
<h3 id="arrays"><a class="header" href="#arrays">Arrays</a></h3>
<p>To pass arrays to modules within the AntiRaid SDK, you need to set the metatable to <code>@antiraid/interop#array_metatable</code>. This will allow the SDK to convert the array to a Rust <code>Vec</code> internally.</p>
<pre><code class="language-lua">local interop = require '@antiraid/interop'
setmetatable({a = 5}, interop.array_metatable)
</code></pre>
<h3 id="null"><a class="header" href="#null">Null</a></h3>
<p>While the Lua <code>nil</code> does work in many cases (and even when calling the SDK), its not the best choice. When querying AntiRaid SDK, the SDK will use the <code>@antiraid/interop#null</code> value to represent a null value. Your Lua templates can also use this value if desired</p>
<pre><code class="language-lua">local interop = require '@antiraid/interop'
local null = interop.null -- This is the null value
</code></pre>
<h3 id="memory-usage"><a class="header" href="#memory-usage">Memory Usage</a></h3>
<p>While not strictly useful for interop, it is often desirable to know the memory usage of a Lua template as AntiRaid will kill your template if it exceeds the memory limit. For this, you can use the <code>@antiraid/interop#memusage</code> function.</p>
<pre><code class="language-lua">local interop = require '@antiraid/interop'
print(interop.memusage())
</code></pre>
<h3 id="user-error-vs-runtime-error"><a class="header" href="#user-error-vs-runtime-error">User Error vs Runtime Error</a></h3>
<p>As Lua does not have a built-in way to distinguish between user errors and runtime errors, AntiRaid provides a way to do so. Simply return a table with the key <code>__error</code> set, and the value set to the error message to create a user error. You can use the standard <code>error</code> function for runtime errors. E.g.</p>
<pre><code class="language-lua">-- User Error
return { __error = "You have reached the maximum number of tries in this 5 minute window." }

-- Runtime Error
error("Could not parse user ID for some reason")
</code></pre>
<h2 id="template-tokens"><a class="header" href="#template-tokens">Template Tokens</a></h2>
<p>All Lua templates include a special template token in addition to the template arguments. "Executors" use this token to get access to the low-level per-template state. Examples of executors include the <code>@antiraid/actions</code> <code>ActionExecutor</code>, which allows you to perform actions such as banning/kicking/timing out users and other Discord actions and <code>@antiraid/kv</code> <code>KvExecutor</code> which allow for persistent storage via a key-value interface.</p>
<p>Note that token is randomly generated for each <em>template invocation</em> and is only guaranteed to be valid during a template execution. It is also guaranteed, however, that the created executor is complete and does not rely on the token itself whatsoever after creation. This means that a template executor can be used after the template has finished executing (e.g. in a coroutine).</p>
<h3 id="example"><a class="header" href="#example">Example</a></h3>
<pre><code class="language-lua">local args, token = ...
print(token)
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../user/templating/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../user/templating/2-plugins.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../user/templating/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../user/templating/2-plugins.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
